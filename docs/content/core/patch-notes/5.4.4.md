# Core v5.4.4
**Release Date:** August 20, 2025  
**Tags:** BUG FIXES, INVESTMENT FIXES, AUTHENTICATION FIXES

## Bug Fixes

### Authentication - reCAPTCHA v3 Fixes
#### Backend
- **Fixed** reCAPTCHA token validation error in login endpoint
- **Added** missing validation check for recaptchaToken in `verifyRecaptchaOrThrow` function
- **Resolved** "Recaptcha Token is required" schema validation error
- **Fixed** environment variable loading timing issue - now checks reCAPTCHA status at runtime
- **Updated** schema to make recaptchaToken always nullable, validating in handler instead
- **Fixed** incorrect environment variable name in `verifyRecaptcha` function (was using `GOOGLE_RECAPTCHA_SECRET_KEY` instead of `NEXT_PUBLIC_GOOGLE_RECAPTCHA_SECRET_KEY`)
- **Added** better error logging in reCAPTCHA verification
- **Ensured** consistent error handling across all authentication endpoints (login, register, reset)

#### Frontend
- **Improved** reCAPTCHA v3 script loading with retry mechanism
- **Added** wait logic to ensure grecaptcha object is available before executing
- **Fixed** race condition where auth modal opens before reCAPTCHA script is loaded
- **Fixed** logic to always send recaptchaToken when reCAPTCHA is enabled
- **Enhanced** error messages for better user feedback when reCAPTCHA fails
- **Added** console logging for debugging reCAPTCHA loading issues
- **Prevented** duplicate script loading when multiple auth forms are present

### Investment Display Issues
- **Fixed** multiple active investment plans not showing on user dashboard
- **Fixed** investment history only displaying one active investment instead of all
- **Updated** API endpoints to return all active investments instead of just one
- **Changed** `findOne` to `findAll` in investment retrieval functions
- **Improved** user experience by showing complete investment portfolio

## Technical Details

### Files Modified

#### Backend

##### Authentication Endpoints
- `backend/src/api/auth/login/index.post.ts`
  - Added validation check for recaptchaToken in `verifyRecaptchaOrThrow` function (lines 131-136)
  - Ensures proper error message when reCAPTCHA token is missing

##### Frontend Auth Components
- `frontend/components/auth/login-form.tsx`
  - Added retry mechanism for reCAPTCHA loading (lines 158-181)
  - Improved error handling and user feedback
  - Enhanced script loading detection

- `frontend/components/auth/register-form.tsx`
  - Applied same reCAPTCHA loading improvements
  - Added wait logic and retry mechanism

- `frontend/components/auth/forgot-password-form.tsx`
  - Updated reCAPTCHA handling consistency
  - Added debugging logs and better error messages

##### Investment Endpoints
- `backend/src/api/finance/investment/user.get.ts`
  - Changed `getUserInvestment` function from `findOne` to `findAll` (line 64)
  - Updated return type to handle array of investments
  - Modified error handling for multiple investments
  
- `backend/src/api/finance/investment/index.get.ts`
  - Updated `getActiveInvestment` function to use `findAll` (line 133)
  - Fixed return value to map over all active investments
  - Enhanced response handling for multiple investments

## Impact
- **Users** can now see all their active investment plans on the dashboard
- **Investment history** properly displays all active investments
- **Portfolio management** improved with complete visibility of all investments

## Migration Notes
- No database migrations required
- Changes are backward compatible
- Frontend already supports array handling

## Support
For issues or questions regarding these fixes, please refer to the documentation or contact support.